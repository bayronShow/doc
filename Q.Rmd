---
title: "10 Lab"
author: "bayron Show"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
```{r packs,include=FALSE}
library(lubridate)
library(tidyverse)
library(nycflights13)
library(ggplot2)
library(dplyr)
```

## Как в течение года меняется распределение времени полета в течение дня?

```{r}
  ggplot(flights, aes(x = dep_time/100, fill = factor(month))) +
  geom_histogram(binwidth = 0.25, alpha = 0.5) +
  labs(x = "Время вылета", y = "Количество рейсов", fill = "Месяц") +
  scale_x_continuous(limits = c(0, 24))
```

На основании гистограммы распределения времени вылета рейсов в зависимости от месяца, можно сделать вывод, что распределение времени полета в течение дня меняется в течение года. Например, летом чаще происходят вылеты вечером и ночью, а зимой - днем. Весной и осенью можно наблюдать более равномерное распределение вылетов в течение дня. Также можно заметить, что среди всех месяцев, июль и август являются самыми популярными для вылетов в течение дня. В целом, изменение распределения времени полета в течение дня в течение года может быть связано с сезонными изменениями в туристическом спросе, изменением климатических условий и другими факторами.

## Сравните `dep_time`,`sched_dep_time` и `dep_delay`.Последовательны ли они? Объясните свои выводы.
```{r}
flights %>%    
  #отбираем столбцы dep_time, sched_dep_time и dep_delay
  select(dep_time, sched_dep_time, dep_delay) %>%
  head()                           

```
`dep_time` - время вылета рейса, `sched_dep_time` - запланированное время вылета рейса, `dep_delay` - разница между временем вылета и запланированным временем вылета.Из результатов видно, что значения `dep_time` и `sched_dep_time` не всегда совпадают. Это свидетельствует о том, что рейсы могут отправляться не в точности в то время, которое было запланировано.

Значение `dep_delay` показывает разницу между временем вылета и запланированным временем вылета. Если значение положительное, то рейс вылетел позже запланированного времени, если отрицательное - раньше.

Таким образом, можно сделать вывод, что значения `dep_time`, `sched_dep_time` и `dep_delay` не являются последовательными.`Dep_delay` зависит от разницы между `dep_time` и `sched_dep_time`, которая может меняться в зависимости от фактического времени вылета рейса.

## Сравните `air_time` с продолжительностью между вылетом и прибытием. Объясните свои выводы. (Подсказка: учитывайте расположение аэропорта.)
```{r}
flights %>%
  #создаем новый столбец flight_time, который вычисляет разницу между временем прибытия и вылета 
  mutate(flight_time = arr_time - dep_time) %>%
  #выбираем только столбцы air_time и flight_time
  select(air_time, flight_time) %>%
  head()

```
`air_time` - время в полете, `flight_time` - продолжительность между вылетом и прибытием.Из результатов можно сделать вывод, что `air_time` и продолжительность между вылетом и прибытием не всегда совпадают. Продолжительность между вылетом и прибытием может включать в себя время на руление, ожидание взлета или посадки, а также время на транспортировку по рулежной дорожке после посадки.

В то же время `air_time` показывает только время нахождения в воздухе, когда самолет находится на высоте и летит со скоростью крейсерского полета.

Кроме того, расположение аэропорта также может оказывать влияние на разницу между `air_time` и `flight_time`. Например, если аэропорт назначения находится ближе к точке отправления, то время на руление и ожидание может быть меньше, что приведет к более короткому `flight_time` и меньшей разнице с `air_time`.

Таким образом, можно сделать вывод, что air_time и продолжительность между вылетом и прибытием не всегда совпадают, и разница между ними может зависеть от различных факторов, таких как расстояние между аэропортами,такими как погодные условия, наличие штормов и турбулентности/

## Как меняется среднее время задержки в течение дня? Что следует использовать: `dep_time` или `sched_dep_time`? Почему?

```{r}
# преобразуем время вылета и планируемое время вылета в формат POSIXct
flights <- flights %>%
  mutate(sched_dep_time = as.POSIXct(paste(year, month, day, sched_dep_time), format = "%Y %m %d %H%M", tz = "America/New_York"),
         dep_time = as.POSIXct(paste(year, month, day, dep_time), format = "%Y %m %d %H%M", tz = "America/New_York"))

# Удаляем строки, содержащие отсутствующие значения для переменной dep_time
flights <- flights %>%
  drop_na(dep_time)

#создаем новую переменную delay, которая содержит разницу между временем вылета и планируемым временем вылета, затем группируем данные по часу дня потом вычисляем среднюю задержку для каждого часа
flights_delay <- flights %>%
  mutate(delay = dep_time - sched_dep_time)
delay_by_hour <- flights_delay %>%
  group_by(hour = hour(dep_time)) %>%
  summarise(mean_delay = mean(delay, na.rm = TRUE))

#строим график линии средней задержки вылета по часам дня
ggplot(data = delay_by_hour, aes(x = hour, y = mean_delay)) +
  geom_line() +
  labs(title = "Средняя задержка вылета по каждому часу дня",
       x = "Час дня",
       y = "Средняя задержка (минуты)")
```

Полученный график покажет, как меняется среднее время задержки в течение дня.Так же из графика можно сделать вывод,что среднее время задержки меняеется.В основном наблюдается увеличение задержки в первой половине дня и ее уменьшение после полудня.Какое время использовать для анализа задержек - dep_time или sched_dep_time?в этом случае лучше использовать sched_dep_time, то есть запланированное время вылета. Это связано с тем, что задержки могут быть вызваны различными факторами, такими как погодные условия, отсутствие персонала, наличие технических проблем и другие факторы, которые могут возникнуть после запланированного времени вылета. Таким образом, использование sched_dep_time позволяет оценить, какие временные периоды имеют большую вероятность задержек, и определить возможные причины этих задержек.

##  В какой день недели лучше уехать, если вы хотите свести к минимуму вероятность задержки?

```{r}
flights %>%
  #добавляем новый столбец "weekday" с помощью функции mutate(), которая вычисляет день недели (от 1 до 7) на основе столбца "time_hour" с помощью функции wday() из библиотеки lubridate. Параметр "label = TRUE" используется для того, чтобы получить дни недели в текстовом формате (например, "Mon", "Tue" и т.д.)
  mutate(weekday = wday(time_hour, label = TRUE)) %>%  
  group_by(weekday) %>% 
  #вычисляем среднее значение "dep_delay" (времени задержки вылета) для каждого дня недели, используя функцию summarise() и вычисление среднего значения с помощью функции mean(). Параметр "na.rm = TRUE" используется для того, чтобы убрать отсутствующие значения в вычислениях
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE)) %>%  
  #упорядочиваем строки в порядке возрастания среднего времени задержки вылета для каждого дня недели с помощью функции arrange()
  arrange(avg_delay)  

```

`weekday` - это день недели, а `avg_delay` - это средняя задержка вылета рейса в минутах для каждого дня недели.Этот график поокажет,что среднее время задержки по дням недели, отсортированное по возрастанию. Например, если мы увидим, что наименьшее среднее время задержки приходится на понедельник, то можно заключить, что понедельник - лучший день недели для выезда, если хотите свести к минимуму вероятность задержки.

Таким образом, можно использовать этот подход, чтобы определить, в какой день недели имеет наименьшую вероятность задержки, и выбрать этот день для выезда, если это возможно. Однако стоит учитывать, что вероятность задержки может быть вызвана различными факторами, такими как погодные условия, отсутствие персонала и другие факторы, которые могут изменяться от дня к дню. Поэтому, помимо дня недели, стоит учитывать и другие факторы, такие как погодные условия, при выборе времени вылета.

## Подтвердите гипотезу о том, что ранние вылеты рейсов через 20-30 и 50-60 минут вызваны ранним вылетом регулярных рейсов. Подсказка: создайте двоичную переменную, которая сообщает вам, был ли задержан рейс.

```{r}
#создание нового столбца в таблице "flights", который будет равен 1, если вылет был задержан, и 0, если нет
flights <- flights %>%
  mutate(delayed = ifelse(dep_delay > 0, 1, 0))

#создание еще одного нового столбца в таблице "flights", который будет равен 1, если перевозчик был AA, DL, UA или WN, и 0, если нет
flights <- flights %>%
  mutate(regular = ifelse(carrier %in% c("AA", "DL", "UA", "WN"), 1, 0))
#фильтрация данных таким образом, чтобы оставить только рейсы, которые были задержаны и выполняются регулярными перевозчиками
regular_delayed_flights <- flights %>%
  filter(regular == 1 & delayed == 1)
#построение гистограммы распределения задержек вылета регулярных рейсов
ggplot(regular_delayed_flights, aes(x = dep_delay)) +
  geom_histogram(binwidth = 10) + # Гистограмма с шириной столбцов 10 минут
  labs(x = "Задержка вылета самолета в минутах",y = "количество наблюдений рейсов") 
#построение гистограммы распределения задержек вылета регулярных рейсов с вертикальными линиями, обозначающими некоторые точки на графике
ggplot(regular_delayed_flights, aes(x = dep_delay)) +
  geom_histogram(binwidth = 10) + # Гистограмма с шириной столбцов 10 минут
  geom_vline(xintercept = c(-30, -20, 20, 30, 50, 60), color = "red") + # Вертикальные линии с заданными координатами и красным цветом
  labs(
       x = "Задержка вылета самолета в минутах",
       y = "количество наблюдений рейсов")

```

***Красные линии на графике обозначают интервалы времени вылета рейсов через 20-30 и 50-60 минут соответственно***

Если мы увидим, что задержки в интервалах 20-30 и 50-60 минут встречаются с большей частотой, чем другие задержки, то это может свидетельствовать о том, что ранние вылеты регулярных рейсов влияют на вылеты других рейсов.В итоге, после анализа графика, если мы увидим, что задержки в интервалах 20-30 и 50-60 минут встречаются с большей частотой, чем другие задержки, то это может свидетельствовать о том, что ранние вылеты регулярных рейсов влияют на вылеты других рейсов.

Если среднее время задержки для рейсов, вылетающих через 20-30 и 50-60 минут после предыдущего рейса, значительно отличается от среднего времени задержки для рейсов, вылетающих не через эти интервалы, то мы можем сделать вывод, что ранние вылеты этих рейсов вызваны ранним вылетом регулярных рейсов.Так же необходимо учитывать, что на время задержки могут влиять другие факторы, такие как погода, кол-ва пассажиров и т.д, которые не отражены в данных. Поэтому, для более точного анализа необходимо учитывать дополнительные факторы.